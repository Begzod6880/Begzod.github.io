import logging
from telegram import Update, ReplyKeyboardMarkup, InlineKeyboardButton, InlineKeyboardMarkup 
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler
from PIL import Image 
import io
from PyPDF2 import PdfMerger, PdfReader, PdfWriter 
import os

# Logging sozlamalari
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# Til sozlamalari
TEXTS = {
    'uz': {
        'welcome': "üëã Assalomu alaykum!\n\nü§ñ Men PDF va fayl bilan ishlaydigan botman.\n\nTilni tanlang:",
        'main_menu': "üìã Asosiy menyu:\n\nKerakli bo'limni tanlang:",
        'send_images': "üì∏ Iltimos, PDF qilmoqchi bo'lgan rasmlarni yuboring.\n\nTayyor bo'lganingizda /done buyrug'ini yuboring.",
        'no_images': "‚ùå Hech qanday rasm topilmadi. Avval rasm yuboring.",
        'creating_pdf': "‚è≥ PDF yaratilmoqda...",
        'pdf_ready': "‚úÖ PDF tayyor! Mana sizning faylingiz:",
        'send_file': "üìÅ Iltimos, hajmini kichraytirmoqchi bo'lgan faylingizni yuboring.",
        'compressing': "‚è≥ Fayl siqilmoqda...",
        'compressed': "‚úÖ Fayl siqildi! Hajm: {original}MB ‚Üí {compressed}MB",
        'ad_message': "üíº PROFESSIONAL XIZMATLAR\n\nüìù Men quyidagi ishlarni sifatli va tez bajaraman:\n\n‚Ä¢ Referat yozish\n‚Ä¢ Kurs ishlari\n‚Ä¢ Mustaqil ishlar\n‚Ä¢ Diplom ishlari\n\nüí∞ Narxlar: 10,000 so'mdan boshlab\n‚ö°Ô∏è Tez muddatda\n‚úÖ Plagiat tekshirilgan\n\nüìû Bog'lanish: @begi_133",
        'menu_image_to_pdf': "üñº Rasm ‚Üí PDF",
        'menu_compress': "üì¶ Fayl hajmini kichraytirish",
        'menu_ad': "üíº Xizmatlar haqida",
        'menu_language': "üåê Tilni o'zgartirish",
        'error': "‚ùå Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring."
    },
    'ru': {
        'welcome': "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n\nü§ñ –Ø –±–æ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PDF –∏ —Ñ–∞–π–ª–∞–º–∏.\n\n–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
        'main_menu': "üìã –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:\n\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:",
        'send_images': "üì∏ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ PDF.\n\n–ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /done.",
        'no_images': "‚ùå –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.",
        'creating_pdf': "‚è≥ –°–æ–∑–¥–∞—é PDF...",
        'pdf_ready': "‚úÖ PDF –≥–æ—Ç–æ–≤! –í–æ—Ç –≤–∞—à —Ñ–∞–π–ª:",
        'send_file': "üìÅ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Å–∂–∞—Ç–∏—è.",
        'compressing': "‚è≥ –°–∂–∏–º–∞—é —Ñ–∞–π–ª...",
        'compressed': "‚úÖ –§–∞–π–ª —Å–∂–∞—Ç! –†–∞–∑–º–µ—Ä: {original}MB ‚Üí {compressed}MB",
        'ad_message': "üíº –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ï –£–°–õ–£–ì–ò\n\nüìù –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é:\n\n‚Ä¢ –†–µ—Ñ–µ—Ä–∞—Ç—ã\n‚Ä¢ –ö—É—Ä—Å–æ–≤—ã–µ —Ä–∞–±–æ—Ç—ã\n‚Ä¢ –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã\n‚Ä¢ –î–∏–ø–ª–æ–º–Ω—ã–µ —Ä–∞–±–æ—Ç—ã\n\nüí∞ –¶–µ–Ω—ã: –æ—Ç 20,000 —Å—É–º\n‚ö°Ô∏è –ë—ã—Å—Ç—Ä—ã–µ —Å—Ä–æ–∫–∏\n‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–ª–∞–≥–∏–∞—Ç\n\nüìû –ö–æ–Ω—Ç–∞–∫—Ç: @YourUsername",
        'menu_image_to_pdf': "üñº –§–æ—Ç–æ ‚Üí PDF",
        'menu_compress': "üì¶ –°–∂–∞—Ç—å —Ñ–∞–π–ª",
        'menu_ad': "üíº –û —É—Å–ª—É–≥–∞—Ö",
        'menu_language': "üåê –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫",
        'error': "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    }
}

# Foydalanuvchi ma'lumotlarini saqlash
user_data = {}

def get_text(user_id, key):
    """Foydalanuvchi tili bo'yicha matnni qaytaradi"""
    lang = user_data.get(user_id, {}).get('lang', 'uz')
    return TEXTS[lang][key]

def get_main_keyboard(user_id):
    """Asosiy klaviaturani yaratadi"""
    lang = user_data.get(user_id, {}).get('lang', 'uz')
    keyboard = [
        [TEXTS[lang]['menu_image_to_pdf']],
        [TEXTS[lang]['menu_compress']],
        [TEXTS[lang]['menu_ad']],
        [TEXTS[lang]['menu_language']]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Bot ishga tushganda"""
    user_id = update.effective_user.id
    
    # Til tanlash tugmalari
    keyboard = [
        [InlineKeyboardButton("üá∫üáø O'zbek", callback_data='lang_uz'),
         InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data='lang_ru')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üëã Assalomu alaykum! / –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n\nü§ñ Tilni tanlang / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
        reply_markup=reply_markup
    )

async def language_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Til tanlash callback"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    lang = query.data.split('_')[1]
    
    if user_id not in user_data:
        user_data[user_id] = {}
    user_data[user_id]['lang'] = lang
    user_data[user_id]['images'] = []
    
    await query.edit_message_text(get_text(user_id, 'main_menu'))
    await context.bot.send_message(
        chat_id=user_id,
        text=get_text(user_id, 'main_menu'),
        reply_markup=get_main_keyboard(user_id)
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Xabarlarni qayta ishlash"""
    user_id = update.effective_user.id
    text = update.message.text
    
    if user_id not in user_data:
        user_data[user_id] = {'lang': 'uz', 'images': [], 'mode': None}
    
    lang = user_data[user_id]['lang']
    
    # Menyu tugmalari
    if text == TEXTS[lang]['menu_image_to_pdf']:
        user_data[user_id]['mode'] = 'image_to_pdf'
        user_data[user_id]['images'] = []
        await update.message.reply_text(get_text(user_id, 'send_images'))
    
    elif text == TEXTS[lang]['menu_compress']:
        user_data[user_id]['mode'] = 'compress'
        await update.message.reply_text(get_text(user_id, 'send_file'))
    
    elif text == TEXTS[lang]['menu_ad']:
        await update.message.reply_text(get_text(user_id, 'ad_message'))
    
    elif text == TEXTS[lang]['menu_language']:
        keyboard = [
            [InlineKeyboardButton("üá∫üáø O'zbek", callback_data='lang_uz'),
             InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data='lang_ru')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text("Tilni tanlang / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:", reply_markup=reply_markup)

async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Rasm qabul qilish"""
    user_id = update.effective_user.id
    
    if user_id not in user_data or user_data[user_id].get('mode') != 'image_to_pdf':
        return
    
    photo = update.message.photo[-1]
    file = await photo.get_file()
    photo_bytes = await file.download_as_bytearray()
    
    user_data[user_id]['images'].append(photo_bytes)
    await update.message.reply_text(f"‚úÖ Rasm qabul qilindi. Jami: {len(user_data[user_id]['images'])}")

async def done_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """PDF yaratish"""
    user_id = update.effective_user.id
    
    if user_id not in user_data or not user_data[user_id]['images']:
        await update.message.reply_text(get_text(user_id, 'no_images'))
        return
    
    await update.message.reply_text(get_text(user_id, 'creating_pdf'))
    
    try:
        # Rasmlarni PDF ga aylantirish
        images = []
        for img_bytes in user_data[user_id]['images']:
            img = Image.open(io.BytesIO(img_bytes))
            if img.mode != 'RGB':
                img = img.convert('RGB')
            images.append(img)
        
        # PDF yaratish
        pdf_bytes = io.BytesIO()
        images[0].save(pdf_bytes, format='PDF', save_all=True, append_images=images[1:])
        pdf_bytes.seek(0)
        
        # PDF yuborish
        await update.message.reply_document(
            document=pdf_bytes,
            filename='converted.pdf',
            caption=get_text(user_id, 'pdf_ready')
        )
        
        # Reklama xabari
        await update.message.reply_text(get_text(user_id, 'ad_message'))
        
        # Tozalash
        user_data[user_id]['images'] = []
        user_data[user_id]['mode'] = None
        
    except Exception as e:
        logger.error(f"PDF yaratishda xatolik: {e}")
        await update.message.reply_text(get_text(user_id, 'error'))

async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Faylni qabul qilish va siqish"""
    user_id = update.effective_user.id
    
    if user_id not in user_data or user_data[user_id].get('mode') != 'compress':
        return
    
    await update.message.reply_text(get_text(user_id, 'compressing'))
    
    try:
        document = update.message.document
        file = await document.get_file()
        file_bytes = await file.download_as_bytearray()
        
        original_size = len(file_bytes) / (1024 * 1024)  # MB
        
        # Oddiy siqish (real loyihada optimallashtiriladi)
        compressed_bytes = file_bytes  # Bu yerda haqiqiy siqish algoritmini qo'shish kerak
        compressed_size = len(compressed_bytes) / (1024 * 1024)
        
        # Yuborish
        await update.message.reply_document(
            document=io.BytesIO(compressed_bytes),
            filename=f"compressed_{document.file_name}",
            caption=get_text(user_id, 'compressed').format(
                original=f"{original_size:.2f}",
                compressed=f"{compressed_size:.2f}"
            )
        )
        
        user_data[user_id]['mode'] = None
        
    except Exception as e:
        logger.error(f"Faylni siqishda xatolik: {e}")
        await update.message.reply_text(get_text(user_id, 'error'))

def main():
    """Botni ishga tushirish"""
    # Bu yerga BotFather'dan olgan tokeningizni qo'ying
    TOKEN = "8567755526:AAHJZIaLlSrbN9SI0WJ1UfrM5L0iF7i4MLQ"
    
    application = Application.builder().token(TOKEN).build()
    
    # Handlerlar
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("done", done_command))
    application.add_handler(CallbackQueryHandler(language_callback, pattern='^lang_'))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    application.add_handler(MessageHandler(filters.PHOTO, handle_photo))
    application.add_handler(MessageHandler(filters.Document.ALL, handle_document))
    
    # Botni ishga tushirish
    print("Bot ishga tushdi...")
    application.run_polling()

if __name__ == '__main__':
    main()

